<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="node_modules/layui-src/dist/css/layui.css"/>
    <script type="text/javascript" src="node_modules/jquery/dist/jquery.min.js"></script>
    <script type="text/javascript" src="node_modules/layui-src/dist/layui.all.js"></script>
    <script>
        //设置用户激活状态
        function setActiveStatus(status,user_id){
            $.ajax({
                url:"admin/updateActiveStatus.do",
                method:"post",
                data:{
                    "user_id":user_id,
                    "status":status
                },
                success:function (data) {
                    if(data == 1)
                        layer.msg("设置成功");
                    else
                        layer.msg("设置失败");
                },error:function(){
                    layer.msg("请求服务器失败")
                }
            })
        }
        //设置为管理员
        function setAdminStatus(user_id,isAdmin){
            $.ajax({
                url:"admin/updateAdminStatus.do",
                method:"get",
                data:{
                    "user_id":user_id,
                    "isAdmin":isAdmin
                },
                success:function (data) {
                    if(data==1){
                        layer.msg("设置成功")
                    }else{
                        layer.msg("设置失败")
                    }
                },error:function () {
                    layer.msg("请求服务器失败")
                }
            })
        }

        // 页面一加载就执行的函数
        $(function () {
            layui.use("table", function () {
                //alert(row);
                layui.table.render({
                    elem: "#user_table",
                    url: "admin/getAllUsers.do",
                    title: "用户列表",
                    // where: {
                    //     "user_id": sessionStorage.getItem("user_id")
                    // },
                    page: true,
                    id: "id",
                    loading: true,
                    skin: "row",
                    limit: 5,
                    size: "md",
                    even: true,
                    toolbar: '#tb_toolbar',
                    cols: [[
                        {field: "user_id", title: "ID", fixed: true, type: "checkbox"},
                        {
                            field: "username", title: "用户名", width: 150,
                            templet: function (row) {
                                return row.username;
                            }
                        },
                        {
                            field: "password", title: "密码", width: 150,
                            templet: function (row) {
                                return row.password;
                            }
                        },
                        {
                            field: " isAdmin", title: "是否为管理员", sort: true, width: 120,
                            templet: function (row) {
                                if (row.isAdmin == 1)
                                    return "<a href='javascript:setAdminStatus(" + row.user_id + "," + row.isAdmin + ")'> " +
                                        "<input type='checkbox' name='switch' lay-skin='switch' lay-text='管理员|用户' value='1' checked></a>";
                                else
                                    return "<a href='javascript:setAdminStatus(" + row.user_id + "," + row.isAdmin + ")'>" + "<input type='checkbox' name='switch' lay-skin='switch' lay-text='管理员|用户' value='0' ></a>";
                            }
                        },
                        {
                            field: "email", title: "注册邮箱", width: 200,
                            templet: function (row) {
                                return row.email;
                            }
                        },
                        {
                            field: "register_time", title: "注册时间", width: 200,
                            templet: function (row) {
                                return new Date(row.register_time).toLocaleString();
                            }
                        },
                        {
                            field: "status", title: "激活", width: 120,
                            templet: function (row) {
                                if (row.status == 1)
                                    return "<a href='javascript:setActiveStatus(" + row.status + "," + row.user_id + ")'> " +
                                        //"<input type='checkbox' name='switch' lay-skin='switch' lay-text='已激活|未激活' value='1' checked></a>";
                                        "<input name='status' title='&nbsp;&nbsp;&nbsp;&nbsp;激活' type='checkbox' checked lay-skin='primary'  value='1'></a>";
                                else
                                    return "<a href='javascript:setActiveStatus(" + row.status + "," + row.user_id + ")'> " +
                                        "<input name='status' title='未激活' type='checkbox' lay-skin='primary'  value='0'></a>";
                            }
                        },

                        {
                            field: "user_id", title: "操作", width: 160,
                            templet: function (row) {
                                return "<a href='' title='删除'><span class='layui-icon layui-icon-delete'></span></a> &nbsp;&nbsp;"
                                    //+"<a href='file/downloadFile_1.do?filePath=" + row.file_path + "&fileName=" + row.file_name + "&file_id=" + row.file_id + "' title='删除' ><span class='layui-icon layui-icon-download-circle'></span></a>";
                            }
                        }
                    ]]
                });


            });
        });

        layui.table.on("toolbar(usertable)", function (rs) {
            var event = rs.event;
            if (event == "add") {
                layer.msg(event);
            }
            if (event == "delete") {
                var tableselectdate = layui.table.checkStatus("id").data;
                var arr = new Array();
                $.each(tableselectdate, function (index, row, rs) {
                    arr[index] = row.user_id;
                });
                if (arr.length == 0) {
                    layer.msg("请选择一行数据");
                } else {
                    layer.confirm('是否要真的删除选中数据？', {
                        btn: ['确定', '取消'], //按钮
                        btnAlign: 'c'  //按钮居中显示
                    }, function () {
                        $.ajax({
                            url: "admin/deleteUserById.do",
                            data: {"user_id": JSON.stringify(arr)},
                            method: "post",
                            success: function (data) {
                                if (data > 0)
                                    layer.msg("成功删除" + data + "个文件", {icon: 1});
                                else
                                    layer.msg('文件删除失败', {icon: 2});
                                /*数据删除成功后刷新表格*/
                                layui.table.reload("id", {
                                    where: {
                                        "user_id": sessionStorage.getItem("user_id")
                                    }
                                });
                            },
                            error: function () {
                                layer.msg('请求服务器失败！', {icon: 1});
                            }
                        });
                    });
                }
            }
        });
        //获取所有用户信息

    </script>
</head>
<body>
<table id="user_table" lay-filter="usertable"></table>
</body>
</html>
<script type="text/html" id="tb_toolbar">
    <button class="layui-btn layui-btn-normal" lay-event="add" style="background-color: #009688">
        <span class="layui-icon layui-icon-add-1"></span>添加
    </button>
    <button class="layui-btn layui-btn-normal" lay-event="edit" style="background-color: #009688">
        <span class="layui-icon layui-icon-edit"></span>修改
    </button>
    <button class="layui-btn layui-btn-normal" lay-event="delete" style="background-color: #009688">
        <span class="layui-icon layui-icon-delete"></span>删除
    </button>
</script>